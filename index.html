<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tabla Precios Web</title>
  <style>
    /* Reset básico */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      padding: 1rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .card {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .flex {
      display: flex;
      gap: 1rem;
    }
    .flex-wrap {
      flex-wrap: wrap;
    }
    .justify-center {
      justify-content: center;
    }
    .items-center {
      align-items: center;
    }
    .form-section {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    textarea {
      width: 100%;
      min-height: 5rem;
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      padding: 0.5rem;
      resize: vertical;
    }
    input[type="radio"],
    input[type="checkbox"] {
      margin: 0;
      transform: translateY(1px);
    }
    label {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-right: 1rem;
      margin-bottom: 0.25rem;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.25rem;
      background-color: #0077ff;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background-color: #005dc1;
    }
    /* Botón de cerrar sin color azul */
    .close-btn {
      background-color: transparent;
      border: none;
      color: black;
      padding: 0;
      margin: 0;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    thead {
      background-color: #f0f0f0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    /* Encabezado de impresión: se oculta en la vista normal y se muestra solo al imprimir */
    #printHeader {
      display: none;
      margin-bottom: 2rem;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .brand {
      background-color: #000;
      color: #fff;
      font-size: 37px;
      padding: 10px 20px;
    }
    .contact {
      text-align: right;
      padding: 10px;
    }
    /* Ocultar la tarjeta de controles en la impresión */
    .no-print {
      display: block;
    }
    /************ REGLAS PARA IMPRESIÓN ************/
    @media print {
      .no-print {
        display: none !important;
      }
      #printHeader {
        display: block !important;
      }
      body {
        font-size: 12px !important;
      }
      .brand {
        font-size: 24px !important;
      }
      table, tbody, td {
        font-size: 9px !important;
      }
      table thead th {
        font-size: 8px !important;
      }
      table tbody td:nth-child(1),
      table tbody td:nth-child(2) {
        font-size: 8px !important;
      }
      .close-btn {
        background-color: transparent !important;
        border: none !important;
        color: black !important;
        padding: 0 !important;
        margin: 0 !important;
      }
    }
    @media (max-width: 768px) {
      .flex {
        flex-direction: column;
      }
      table, thead, tbody, th, td, tr {
        font-size: 0.8rem;
      }
      label {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Encabezado para impresión -->
  <div id="printHeader">
    <div class="header-row">
      <div class="brand">Gabarró</div>
      <div class="contact">
        <p style="margin:0;">
          <strong>Marcos Sanchez</strong><br>
          Tel. 669 22 80 10<br>
          Email Consultas: marcos.sanchez@gabarro.com<br>
          Email Pedidos: ventas.galicia@gabarro.com
        </p>
      </div>
    </div>
    <div style="margin-top:1rem;">
      <p>
        <strong>Precio picking:</strong> se aplica para pedidos superiores a 180 € Netos.<br>
        <strong>Portes:</strong> 30 € para pedidos con un importe inferior a 400 € netos.
      </p>
    </div>
    <hr>
  </div>

  <div class="container">
    <!-- Sección de controles (NO se imprimirá) -->
    <div class="card no-print">
      <h1>Tabla Precios Web</h1>
      <div style="text-align:right; margin-bottom:1rem;">
        <button id="btnPrint">Imprimir PDF</button>
      </div>
      <div class="flex justify-center items-center" style="margin-bottom:0.5rem;">
        <label>
          <input type="radio" name="discountConfig" value="A" checked>
          Cliente A
        </label>
        <label>
          <input type="radio" name="discountConfig" value="B">
          Cliente B
        </label>
        <label>
          <input type="radio" name="discountConfig" value="M">
          Cliente M
        </label>
      </div>
      <div class="form-section">
        <label for="inputData">Pega aquí los datos:</label>
        <textarea id="inputData"></textarea>
      </div>
      <div class="flex" style="justify-content:center; margin-top:0.5rem;">
        <button id="btnAddTable">Agregar Tabla</button>
        <button id="btnClearText">Borrar Texto</button>
      </div>
      <!-- Casilla dedicada para Unidad (m²) -->
      <div class="flex justify-center items-center" style="margin-top:0.5rem;">
        <label>
          <input type="checkbox" id="chkUnidad" checked>
          Unidad (m²)
        </label>
      </div>
      <!-- Se han quitado los checkboxes dinámicos adicionales -->
      <div id="columnsContainer" class="flex flex-wrap justify-center items-center" style="margin-top:1rem;"></div>
    </div>

    <!-- Contenedor de tablas (se imprimirá) -->
    <div id="tablesContainer" class="card"></div>
  </div>

  <script>
    /********** CONFIGURACIÓN DE COLUMNAS **********/
    let columns = {
      codigo: true,
      medidas: true,
      precioBase: true,
      pedidoPicking: true,
      pedidoPaquete: true,
      isOutlet: true
    };

    const columnLabelsDefault = {
      codigo: "Código",
      medidas: "Medidas",
      precioBase: "Precio Base",
      pedidoPicking: "Precio Picking",
      pedidoPaquete: "Precio Paquete",
      isOutlet: "Outlet"
    };

    function getColumnLabel(key) {
      if(key === "pedidoPicking") return "Precio Picking";
      if(key === "pedidoPaquete") return "Precio Paquete";
      return columnLabelsDefault[key] || key;
    }

    /********** VARIABLES GLOBALES **********/
    let discountConfig = "A";  // "A", "B" o "M"
    let tablesData = [];

    // Referencias al DOM
    const inputDataElem = document.getElementById("inputData");
    const btnAddTable = document.getElementById("btnAddTable");
    const btnClearText = document.getElementById("btnClearText");
    const btnPrint = document.getElementById("btnPrint");
    const columnsContainer = document.getElementById("columnsContainer");
    const tablesContainer = document.getElementById("tablesContainer");
    const chkUnidad = document.getElementById("chkUnidad");

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('input[name="discountConfig"]').forEach(radio => {
        radio.addEventListener("change", (e) => {
          discountConfig = e.target.value;
          renderColumnsCheckboxes();
          renderTables();
        });
      });

      chkUnidad.addEventListener("change", () => {
        renderTables();
      });

      btnAddTable.addEventListener("click", () => {
        const newRows = parseData();
        if(newRows.length > 0) {
          tablesData.push(newRows);
          renderTables();
        }
      });

      btnClearText.addEventListener("click", () => {
        inputDataElem.value = "";
      });

      btnPrint.addEventListener("click", () => {
        window.print();
      });

      renderColumnsCheckboxes();
    });

    /********** RENDERIZADO DE CHECKBOXES **********/
    function renderColumnsCheckboxes() {
      columnsContainer.innerHTML = "";
      for(let colKey in columns) {
        // No se generan checkboxes adicionales para la unidad, para evitar duplicidad
        if(colKey === "unidadMedida") continue;

        const label = document.createElement("label");
        label.textContent = getColumnLabel(colKey);
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = columns[colKey];
        checkbox.addEventListener("change", () => {
          columns[colKey] = checkbox.checked;
          renderTables();
        });
        label.prepend(checkbox);
        columnsContainer.appendChild(label);
      }
    }

    /********** PARSEO DE DATOS (NUEVO FORMATO) **********/
    function parseData() {
      const input = inputDataElem.value.trim();
      if (!input) return [];

      // Cada línea es un registro con campos separados por tabulaciones
      const lines = input.split("\n").map(line => line.trim()).filter(line => line !== "");
      let rows = [];

      lines.forEach(line => {
        const fields = line.split("\t");
        // Mapeo:
        // fields[0] => Código
        // fields[1] => Descripción (contiene medidas al final que se quitarán)
        // fields[2] => Largo
        // fields[3] => Ancho
        // fields[4] => Grosor (con punto decimal; si es .00 se muestra sin decimales)
        // fields[5] => "Outlet" (si existe)
        // fields[8] => Precio (ej. "12,99 €")
        let codigo = fields[0] || "";
        let descripcionOriginal = fields[1] || "";
        // Se quitan los últimos números (las medidas) de la descripción
        let descripcion = descripcionOriginal.replace(/\s+\d+\s+\d+\s+\d+(?:\.\d+)?\s*$/, "").trim();

        let largo = parseNumber(fields[2]);
        let ancho = parseNumber(fields[3]);
        let grosor = parseNumber(fields[4]);
        // Formatear el grosor: si es entero se muestra sin decimales
        let formattedGrosor = (grosor % 1 === 0) ? grosor.toString() : grosor.toFixed(2).replace(".", ",");

        let isOutlet = fields[5] && fields[5].toLowerCase().includes("outlet");

        // Extraer el precio (precio por m²) del campo 9 (índice 8)
        const precioStr = fields[8] || "0";
        let precioMatch = precioStr.match(/([\d.,]+)/);
        let priceM2 = precioMatch ? parseNumber(precioMatch[1]) : 0;

        // Armar la cadena de medidas usando el grosor formateado
        let medidas = `${largo}x${ancho}x${formattedGrosor}`;

        let row = {
          codigo,
          descripcion,
          largo,
          ancho,
          grosor,
          priceM2,
          medidas,
          isOutlet: isOutlet ? "Sí" : "No"
        };

        rows.push(row);
      });

      // Ordenar por grosor ascendente (opcional)
      rows.sort((a, b) => a.grosor - b.grosor);
      return rows;
    }

    /********** CÁLCULO DE DESCUENTOS **********/
    // Se recibe el precio base (por m² o por tablero) y se aplican los descuentos
    function calculateDiscounts(precioBase) {
      let precioPicking, precioPaquete;

      switch(discountConfig) {
        case "B":
          precioPicking = (precioBase * (1 - 0.28)).toFixed(2) + " €";
          precioPaquete = (precioBase * (1 - 0.33)).toFixed(2) + " €";
          break;
        case "M":
          precioPicking = (precioBase * (1 - 0.34)).toFixed(2) + " €";
          precioPaquete = (precioBase * (1 - 0.37)).toFixed(2) + " €";
          break;
        default: // Cliente A
          precioPicking = (precioBase * (1 - 0.31)).toFixed(2) + " €";
          precioPaquete = (precioBase * (1 - 0.36)).toFixed(2) + " €";
          break;
      }

      return {
        pedidoPicking: precioPicking,
        pedidoPaquete: precioPaquete
      };
    }

    /********** RENDERIZADO DE TABLAS **********/
    function renderTables() {
      // Actualiza el título con la coletilla según la casilla Unidad
      let unidadTexto = chkUnidad.checked ? "por M2" : "por Tablero";
      tablesContainer.innerHTML = `<h2>Tablas de Precios Netos ${unidadTexto}</h2>`;

      tablesData.forEach((rows, index) => {
        const tableWrapper = document.createElement("div");
        tableWrapper.style.marginBottom = "2rem";

        const removeBtn = document.createElement("button");
        removeBtn.textContent = " - ";
        removeBtn.className = "close-btn";
        removeBtn.style.marginBottom = "0.5rem";
        removeBtn.addEventListener("click", () => {
          tablesData.splice(index, 1);
          renderTables();
        });

        const table = document.createElement("table");
        table.innerHTML = generateTableHTML(rows);

        tableWrapper.appendChild(removeBtn);
        tableWrapper.appendChild(table);
        tablesContainer.appendChild(tableWrapper);
      });
    }

    // Genera la tabla recalculando precios según si la casilla "Unidad" (m²) está marcada o no.
    function generateTableHTML(rows) {
      let theadHTML = "<thead><tr>";

      if(columns.codigo) {
        theadHTML += "<th>" + getColumnLabel("codigo") + "</th>";
      }
      theadHTML += "<th>Descripción</th>";
      if(columns.medidas) {
        theadHTML += "<th>" + getColumnLabel("medidas") + "</th>";
      }
      if(columns.precioBase) {
        theadHTML += "<th>" + getColumnLabel("precioBase") + "</th>";
      }
      if(columns.pedidoPicking) {
        theadHTML += "<th>" + getColumnLabel("pedidoPicking") + "</th>";
      }
      if(columns.pedidoPaquete) {
        theadHTML += "<th>" + getColumnLabel("pedidoPaquete") + "</th>";
      }
      if(columns.isOutlet) {
        theadHTML += "<th>" + getColumnLabel("isOutlet") + "</th>";
      }
      theadHTML += "</tr></thead>";

      let tbodyHTML = "<tbody>";
      rows.forEach(row => {
        // Calcular el precio base según la casilla "Unidad":
        // Si está marcada se usa el precio por m²; de lo contrario, se calcula el precio del tablero.
        // Largo y ancho están en mm, se convierten a m² dividiendo su producto por 1,000,000.
        let basePrice = chkUnidad.checked ? row.priceM2 : ((row.largo * row.ancho) / 1000000) * row.priceM2;
        let discounts = calculateDiscounts(basePrice);
        let precioBaseFormatted = formatPrice(basePrice);

        tbodyHTML += "<tr>";
        if(columns.codigo) {
          tbodyHTML += `<td>${row.codigo}</td>`;
        }
        tbodyHTML += `<td>${row.descripcion}</td>`;
        if(columns.medidas) {
          tbodyHTML += `<td>${row.medidas}</td>`;
        }
        if(columns.precioBase) {
          tbodyHTML += `<td>${precioBaseFormatted}</td>`;
        }
        if(columns.pedidoPicking) {
          tbodyHTML += `<td>${discounts.pedidoPicking}</td>`;
        }
        if(columns.pedidoPaquete) {
          tbodyHTML += `<td>${discounts.pedidoPaquete}</td>`;
        }
        if(columns.isOutlet) {
          tbodyHTML += `<td>${row.isOutlet}</td>`;
        }
        tbodyHTML += "</tr>";
      });
      tbodyHTML += "</tbody>";

      return theadHTML + tbodyHTML;
    }

    /********** HELPERS **********/
    // Si el valor contiene coma (precio), se reemplazan los puntos y comas; si no, se usa parseFloat directamente.
    function parseNumber(value) {
      if(!value) return 0;
      if(value.indexOf(",") >= 0) {
        return parseFloat(value.replace(/\./g, "").replace(/,/g, "."));
      } else {
        return parseFloat(value);
      }
    }

    function formatPrice(price) {
      return price.toFixed(2).replace(".", ",") + " €";
    }
  </script>
</body>
</html>
